<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Imp√¥t Public - Le Tr√©sor Public</title>
    <style>
        body { font-family: 'Comic Sans MS', cursive; background-color: #E8F5E9; color: #004d40; margin: 0; text-align: center; }
        #google_translate_element { padding: 10px; background: rgba(255,255,255,0.5); border-bottom: 2px solid #008080; }
        
        .menu-table { margin: 20px auto; background-color: #008080; border-collapse: collapse; border-radius: 10px; overflow: hidden; margin-left: auto; margin-right: auto; }
        .menu-table td { padding: 12px 20px; border: 1px solid #FFFFFF; }
        .menu-table a { text-decoration: none; color: #FFFFFF; font-weight: bold; }
        
        .form-container { background: white; border: 5px solid #008080; border-radius: 30px; width: 90%; max-width: 700px; margin: 20px auto; padding: 25px; box-shadow: 10px 10px 0px #008080; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; }
        @media (max-width: 600px) { .form-grid { grid-template-columns: 1fr; } }

        label { display: block; margin-top: 10px; font-weight: bold; color: #00695c; }
        input, textarea, select { width: 100%; padding: 12px; margin: 5px 0; border-radius: 12px; border: 2px solid #008080; box-sizing: border-box; font-family: inherit; font-size: 14px; }
        
        .full-width { grid-column: 1 / -1; }
        
        .btn-envoi { background: #008080; color: white; border: none; padding: 18px 40px; border-radius: 25px; font-weight: bold; cursor: pointer; font-size: 1.2em; transition: 0.3s; margin-top: 20px; }
        .btn-envoi:hover { transform: scale(1.05); background: #2e7d32; }
        
        .carte-action { background: white; border-left: 10px solid #008080; border-radius: 15px; padding: 20px; margin: 20px auto; max-width: 700px; text-align: left; box-shadow: 4px 4px 10px rgba(0,0,0,0.1); }
        .badge { background: #008080; color: white; padding: 3px 10px; border-radius: 10px; font-size: 0.8em; margin-right: 5px; }
        .reponse-sage { margin-left: 30px; margin-top: 10px; padding: 10px; background: #DCEDC8; border-left: 4px solid #008080; border-radius: 8px; font-size: 0.9em; }
        
        #searchBox { width: 90%; max-width: 700px; padding: 12px; margin: 20px auto; border-radius: 25px; border: 2px solid #008080; }
    </style>
</head>
<body>

    <div id="google_translate_element"></div>
    <script>function googleTranslateElementInit() { new google.translate.TranslateElement({pageLanguage: 'fr'}, 'google_translate_element'); }</script>
    <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <table class="menu-table">
        <tr>
            <td><a href="transition.html?page=index.html">Accueil</a></td>
            <td><a href="transition.html?page=formulaire.html">Semer</a></td>
            <td><a href="transition.html?page=jardin.html">Le Jardin</a></td>
            <td><a href="transition.html?page=impot.html">Imp√¥t Public</a></td>
            <td><a href="transition.html?page=regulation.html">R√©gulation</a></td>
        </tr>
    </table>

    <h1>üìú Registre de l'Imp√¥t Public</h1>
    <p>D√©clarez ici vos travaux citoyens ou vos offres de service pour la communaut√©.</p>

    <div class="form-container">
        <form id="impotForm">
            <div class="form-grid">
                <div>
                    <label>Identit√© / Pseudo :</label>
                    <input type="text" id="nom" placeholder="Qui es-tu ?" required>
                </div>
                <div>
                    <label>Localisation (Ville/Pays) :</label>
                    <input type="text" id="ville" placeholder="O√π s'est pass√© l'action ?" required>
                </div>
                <div>
                    <label>Cat√©gorie de l'Action :</label>
                    <select id="categorie">
                        <option value="Environnement">üåø Environnement / Nature</option>
                        <option value="Social">ü§ù Aide Sociale / Entraide</option>
                        <option value="Administratif">üìë Aide Administrative</option>
                        <option value="Technique">üõ†Ô∏è Bricolage / Technique</option>
                        <option value="Savoir">üìö Transmission de Savoir</option>
                    </select>
                </div>
                <div>
                    <label>Temps consacr√© :</label>
                    <input type="text" id="temps" placeholder="Ex: 2 heures, 1 matin√©e...">
                </div>
                <div class="full-width">
                    <label>Description d√©taill√©e de l'Imp√¥t Citoyen :</label>
                    <textarea id="message" rows="4" placeholder="Qu'as-tu accompli pour le bien commun ?" required></textarea>
                </div>
                <div class="full-width">
                    <label>Besoins pour continuer (facultatif) :</label>
                    <input type="text" id="besoin" placeholder="Mat√©riel, aide, outils...">
                </div>
            </div>
            <button type="submit" id="btnEnvoi" class="btn-envoi">D√âPOSER MA GRAINE AU REGISTRE üåø</button>
        </form>
    </div>

    <input type="text" id="searchBox" onkeyup="filtrer()" placeholder="üîç Rechercher une ville, un nom ou un type de travail...">
    
    <div id="flux-impots">
        <p>Lecture du Grand Livre de l'Imp√¥t...</p>
    </div>

    <script>
        const URL_SERVEUR = "https://script.google.com/macros/s/AKfycbz4ncs9qw_AfmKSER5QST-P0OeKQggQaq86QC6liS53uZ9sx4Lo_-4-h1knXKWqgQMc/exec";

        document.getElementById('impotForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnEnvoi');
            btn.innerText = "Inscription..."; btn.disabled = true;

            const locComplet = `${document.getElementById('ville').value} | Cat: ${document.getElementById('categorie').value} | Temps: ${document.getElementById('temps').value}`;
            const msgComplet = `${document.getElementById('message').value} (Besoin: ${document.getElementById('besoin').value || 'Aucun'})`;

            fetch(URL_SERVEUR, { 
                method: 'POST', mode: 'no-cors', 
                body: JSON.stringify({
                    date: new Date().toLocaleDateString('fr-FR'),
                    type: "impot",
                    nom: document.getElementById('nom').value,
                    localisation: locComplet,
                    message: msgComplet
                })
            }).then(() => { 
                alert("Action inscrite au Tr√©sor Public ! Merci."); 
                location.reload(); 
            });
        });

        function apporterAvis(dest) {
            const m = prompt("Ton message d'encouragement ou ton avis de Sage :");
            if (m) {
                const monNom = prompt("Ton nom :") || "Citoyen Sage";
                fetch(URL_SERVEUR, { 
                    method: 'POST', mode: 'no-cors', 
                    body: JSON.stringify({
                        date: new Date().toLocaleDateString('fr-FR'), 
                        type: "avis_impot", 
                        nom: monNom, 
                        localisation: dest, 
                        message: m
                    })
                }).then(() => { alert("Commentaire ajout√© !"); location.reload(); });
            }
        }

        fetch(URL_SERVEUR)
            .then(r => r.json())
            .then(data => {
                const flux = document.getElementById('flux-impots');
                flux.innerHTML = "";
                
                const actions = data.filter(d => d.type === "impot").reverse();
                const avis = data.filter(d => d.type === "avis_impot");
                
                actions.forEach(c => {
                    let rHTML = ""; 
                    avis.filter(a => a.localisation === c.nom).forEach(a => {
                        rHTML += `<div class="reponse-sage"><b>üåø Sage ${a.nom} :</b> ${a.message}</div>`;
                    });
                    
                    const div = document.createElement('div');
                    div.className = 'carte-action';
                    div.innerHTML = `
                        <small>Le ${c.date}</small><br>
                        <b>üë§ ${c.nom}</b><br>
                        <span class="badge">üìç ${c.localisation}</span>
                        <p style="margin-top:10px;">"${c.message}"</p>
                        ${rHTML}
                        <hr style="border:0; border-top: 1px dotted #008080; margin: 15px 0;">
                        <span style="color:#008080; cursor:pointer; font-weight:bold; font-size:0.85em;" onclick="apporterAvis('${c.nom}')">‚öñÔ∏è DONNER UN AVIS DE SAGE</span>
                    `;
                    flux.appendChild(div);
                });
            });

        function filtrer() {
            let val = document.getElementById('searchBox').value.toLowerCase();
            let cards = document.getElementsByClassName('carte-action');
            for (let c of cards) { 
                c.style.display = c.innerText.toLowerCase().includes(val) ? "" : "none"; 
            }
        }
    </script>
</body>
</html>
