<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>R√©gulation Citoyenne - Le Tr√©sor Public</title>
    <style>
        body { 
            font-family: 'Comic Sans MS', cursive; 
            background-color: #FFFF00; 
            color: #000080; 
            text-align: center; 
            margin: 0; 
            padding: 0; 
        }

        /* MENU */
        .menu-table { 
            margin: 20px auto; 
            background-color: #008080; 
            border-collapse: collapse; 
            border-radius: 10px; 
            overflow: hidden;
        }
        .menu-table td { padding: 10px 15px; border: 1px solid #FFFFFF; }
        .menu-table a { text-decoration: none; color: #FFFFFF; font-weight: bold; }

        /* FORMULAIRE VIOLET (L'√âTOILE) */
        .etoile-form { 
            background: #E6E6FA; 
            border: 4px solid #9370DB; 
            width: 90%; 
            max-width: 600px; 
            margin: 30px auto; 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 8px 8px 0px #9370DB;
        }
        
        h2 { color: #9370DB; margin-top: 10px; }
        label { display: block; text-align: left; font-weight: bold; margin-top: 10px; }
        
        input, textarea { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            border-radius: 10px; 
            border: 2px solid #9370DB; 
            box-sizing: border-box; 
            font-family: inherit; 
        }

        .btn-justice { 
            background: #9370DB; 
            color: white; 
            padding: 18px; 
            border: none; 
            border-radius: 15px; 
            font-weight: bold; 
            cursor: pointer; 
            width: 100%; 
            font-size: 1.2em; 
            transition: 0.3s;
        }
        .btn-justice:hover { background: #6A5ACD; transform: scale(1.02); }

        /* AFFICHAGE DES DOSSIERS */
        .liste-conflits { 
            max-width: 700px; 
            margin: 40px auto; 
            padding: 20px; 
        }
        
        .carte-conflit { 
            background: white; 
            border-left: 10px solid #9370DB; 
            border-radius: 15px; 
            padding: 20px; 
            margin-bottom: 25px; 
            text-align: left; 
            box-shadow: 4px 4px 15px rgba(0,0,0,0.1);
        }

        .date-badge { font-size: 0.8em; color: #666; }
        .nom-citoyen { font-weight: bold; color: #9370DB; font-size: 1.1em; }
        
        #chargement { font-style: italic; color: #008080; padding: 20px; }
    </style>
</head>
<body>

    <table class="menu-table">
        <tr>
            <td><a href="index.html">Accueil</a></td>
            <td><a href="formulaire.html">Semer</a></td>
            <td><a href="jardin.html">Le Jardin</a></td>
            <td><a href="regulation.html">R√©gulation</a></td>
        </tr>
    </table>

    <h2>‚öñÔ∏è Zone de R√©gulation Citoyenne</h2>
    <p><i>Expose ton conflit avec sinc√©rit√©. La communaut√© r√©pondra avec d√©licatesse.</i></p>

    <div class="etoile-form">
        <form id="regForm">
            <label>Ton identit√© amoureuse :</label>
            <input type="text" id="nom" placeholder="Ton nom ou pseudo" required>
            
            <label>Nature du conflit ou de la peine :</label>
            <textarea id="message" rows="6" placeholder="Explique ici la situation qui attend une r√©solution..." required></textarea>
            
            <p><small>En soumettant, tu acceptes le regard bienveillant et la sentence symbolique de tes pairs.</small></p>
            <button type="submit" id="btnEnvoi" class="btn-justice">SOUMETTRE √Ä L'ENSEMBLE üïäÔ∏è</button>
        </form>
    </div>

    <hr style="width: 80%; border: 1px solid #9370DB; opacity: 0.3;">

    <div class="liste-conflits">
        <h3 style="color:#9370DB;">üìú Dossiers d√©pos√©s au Tr√©sor Public</h3>
        <div id="chargement">Appel de la sagesse citoyenne en cours...</div>
        <div id="flux-conflits"></div>
    </div>

    <p><a href="index.html" style="color:#000080; font-weight:bold; text-decoration:none;">‚Üê Retour au Tr√©sor Public</a></p>

    <script>
        // TON URL DE SCRIPT (V√©rifie qu'elle finit bien par /exec)
        const URL_SERVEUR = "https://script.google.com/macros/s/AKfycbz4ncs9qw_AfmKSER5QST-P0OeKQggQaq86QC6liS53uZ9sx4Lo_-4-h1knXKWqgQMc/exec";

        // 1. FONCTION D'ENVOI
        document.getElementById('regForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnEnvoi');
            btn.innerText = "D√©p√¥t en cours...";
            btn.disabled = true;

            const donnees = {
                date: new Date().toLocaleDateString('fr-FR'),
                type: "Conflit",
                nom: document.getElementById('nom').value,
                localisation: "Zone de Paix",
                message: document.getElementById('message').value
            };

            fetch(URL_SERVEUR, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(donnees)
            }).then(() => {
                alert("Ton dossier a bien √©t√© d√©pos√© !");
                location.reload(); // Recharge la page pour voir le message appara√Ætre
            }).catch(err => {
                alert("Erreur lors de l'envoi.");
                btn.disabled = false;
                btn.innerText = "SOUMETTRE √Ä L'ENSEMBLE üïäÔ∏è";
            });
        });

        // 2. FONCTION DE LECTURE (AFFICHE TOUT CE QU'IL Y A DANS LE SHEET)
        fetch(URL_SERVEUR)
            .then(res => res.json())
            .then(data => {
                const chargement = document.getElementById('chargement');
                const flux = document.getElementById('flux-conflits');

                if (data.length === 0) {
                    chargement.innerText = "Le registre est vierge pour le moment.";
                } else {
                    chargement.style.display = 'none';
                    // On affiche du plus r√©cent au plus ancien
                    data.reverse().forEach(item => {
                        // On v√©rifie que le message n'est pas vide
                        if (item.message) {
                            const carte = document.createElement('div');
                            carte.className = 'carte-conflit';
                            carte.innerHTML = `
                                <div class="date-badge">${item.date || 'Date inconnue'}</div>
                                <div class="nom-citoyen">${item.nom || 'Anonyme'}</div>
                                <p>"${item.message}"</p>
                                <hr style="border:0; border-top:1px dashed #9370DB;">
                                <small style="color:#9370DB; cursor:pointer;" onclick="alert('Bient√¥t : Possibilit√© de r√©pondre.')">‚öñÔ∏è Apporter un avis d√©licat</small>
                            `;
                            flux.appendChild(carte);
                        }
                    });
                }
            })
            .catch(error => {
                console.error(error);
                document.getElementById('chargement').innerText = "Erreur de connexion au registre.";
            });
    </script>
</body>
</html>
