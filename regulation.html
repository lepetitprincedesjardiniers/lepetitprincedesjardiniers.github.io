<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>R√©gulation Citoyenne - Justice D√©licate</title>
    <style>
        body { 
            font-family: 'Comic Sans MS', cursive; 
            text-align: center; 
            margin: 0; 
            padding: 0; 
            background-color: #FFFF00; 
            color: #000080; 
        }

        /* MENU */
        .menu-table { 
            margin: 20px auto; 
            background-color: #008080; 
            border-collapse: collapse; 
            border-radius: 10px; 
            overflow: hidden;
        }
        .menu-table td { padding: 10px 15px; border: 1px solid #FFFFFF; }
        .menu-table a { text-decoration: none; color: #FFFFFF; font-weight: bold; }

        /* FORMULAIRE VIOLET */
        .etoile-form { 
            background: #E6E6FA; 
            border: 3px solid #9370DB; 
            width: 90%; 
            max-width: 600px; 
            margin: 30px auto; 
            padding: 30px; 
            border-radius: 20px;
            box-shadow: 8px 8px 0px #9370DB;
        }
        
        textarea, input { 
            width: 100%; padding: 12px; margin: 10px 0; 
            border-radius: 10px; border: 2px solid #9370DB; 
            box-sizing: border-box; font-family: inherit; 
        }

        .btn-justice { 
            background: #9370DB; color: white; padding: 15px; border: none; 
            border-radius: 15px; font-weight: bold; cursor: pointer; 
            width: 100%; font-size: 1.1em;
        }

        /* CARTES DE CONFLITS ET AVIS */
        .liste-conflits { max-width: 700px; margin: 40px auto; padding: 20px; }
        
        .carte-conflit { 
            background: white; border-left: 10px solid #9370DB; 
            border-radius: 15px; padding: 20px; margin-bottom: 25px; 
            text-align: left; box-shadow: 4px 4px 10px rgba(0,0,0,0.1);
        }

        .avis-bulle {
            margin-left: 30px;
            margin-top: 10px;
            padding: 10px;
            background: #f9f4ff;
            border-left: 3px solid #008080;
            border-radius: 0 10px 10px 0;
            font-size: 0.9em;
        }

        .nom-citoyen { font-weight: bold; color: #9370DB; }
        .nom-sage { font-weight: bold; color: #008080; }
        #chargement { font-style: italic; color: #008080; }
    </style>
</head>
<body>

    <table class="menu-table">
        <tr>
            <td><a href="index.html">Accueil</a></td>
            <td><a href="formulaire.html">Semer</a></td>
            <td><a href="jardin.html">Le Jardin</a></td>
            <td><a href="regulation.html">R√©gulation</a></td>
        </tr>
    </table>

    <h2 style="color:#9370DB;">‚öñÔ∏è Zone de R√©gulation Citoyenne</h2>

    <div class="etoile-form">
        <form id="regForm">
            <input type="text" id="nom" placeholder="Ton identit√© amoureuse" required>
            <textarea id="message" rows="4" placeholder="Expose ton conflit ici..." required></textarea>
            <button type="submit" id="btnEnvoi" class="btn-justice">SOUMETTRE √Ä L'ENSEMBLE üïäÔ∏è</button>
        </form>
    </div>

    <div class="liste-conflits">
        <h3 style="color:#9370DB;">üìú Dossiers et Avis de Sagesse</h3>
        <div id="chargement">Appel de la sagesse citoyenne...</div>
        <div id="flux-conflits"></div>
    </div>

    <script>
        const URL_SERVEUR = "https://script.google.com/macros/s/AKfycbz4ncs9qw_AfmKSER5QST-P0OeKQggQaq86QC6liS53uZ9sx4Lo_-4-h1knXKWqgQMc/exec";

        // 1. ENVOYER UN CONFLIT
        document.getElementById('regForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnEnvoi');
            btn.innerText = "Transmission...";
            btn.disabled = true;

            const donnees = {
                date: new Date().toLocaleDateString('fr-FR'),
                type: "conflit",
                nom: document.getElementById('nom').value,
                localisation: "Zone de Paix",
                message: document.getElementById('message').value
            };

            fetch(URL_SERVEUR, { method: 'POST', mode: 'no-cors', body: JSON.stringify(donnees) })
            .then(() => { alert("Dossier d√©pos√© !"); location.reload(); });
        });

        // 2. FONCTION POUR R√âPONDRE (AVIS D√âLICAT)
        function apporterAvis(nomOriginal) {
            const avis = prompt("Quel est ton avis d√©licat pour r√©soudre ce conflit ?");
            if (avis) {
                const nomSage = prompt("Ton identit√© de sage :");
                const donneesAvis = {
                    date: new Date().toLocaleDateString('fr-FR'),
                    type: "avis",
                    nom: nomSage || "Un Sage Anonyme",
                    localisation: nomOriginal, // On utilise le nom de l'auteur du conflit comme lien
                    message: avis
                };

                fetch(URL_SERVEUR, { method: 'POST', mode: 'no-cors', body: JSON.stringify(donneesAvis) })
                .then(() => { alert("Ton avis a √©t√© ajout√©."); location.reload(); });
            }
        }

        // 3. CHARGEMENT ET AFFICHAGE IMBRIQU√â
        fetch(URL_SERVEUR)
            .then(res => res.json())
            .then(data => {
                const chargement = document.getElementById('chargement');
                const flux = document.getElementById('flux-conflits');
                if (data.length === 0) { chargement.innerText = "Le registre est vierge."; return; }
                chargement.style.display = 'none';

                // On s√©pare les donn√©es
                const conflits = data.filter(d => d.type === "conflit").reverse();
                const avis = data.filter(d => d.type === "avis");

                conflits.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'carte-conflit';
                    
                    // Construction des avis pour ce conflit pr√©cis
                    let reponsesHTML = "";
                    avis.forEach(a => {
                        if(a.localisation === c.nom) {
                            reponsesHTML += `
                                <div class="avis-bulle">
                                    <span class="nom-sage">üåø ${a.nom} :</span> ${a.message}
                                </div>`;
                        }
                    });

                    div.innerHTML = `
                        <small>${c.date}</small><br>
                        <span class="nom-citoyen">üë§ ${c.nom}</span>
                        <p style="font-size: 1.1em; font-style: italic;">"${c.message}"</p>
                        <div class="zone-reponses">${reponsesHTML}</div>
                        <hr style="border:0; border-top: 1px dotted #9370DB; margin-top:15px;">
                        <span style="color:#9370DB; cursor:pointer; font-weight:bold; font-size:0.9em;" 
                              onclick="apporterAvis('${c.nom}')">
                              ‚öñÔ∏è Apporter un avis d√©licat
                        </span>
                    `;
                    flux.appendChild(div);
                });
            })
            .catch(err => { console.error(err); chargement.innerText = "Erreur de chargement."; });
    </script>
</body>
</html>
