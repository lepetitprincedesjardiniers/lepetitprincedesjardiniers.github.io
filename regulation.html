<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©gulation - Le Tr√©sor Public</title>
    <style>
        body { font-family: 'Comic Sans MS', cursive; background-color: #FFF9C4; color: #000080; margin: 0; text-align: center; }
        #google_translate_element { padding: 10px; background: rgba(255,255,255,0.5); border-bottom: 2px solid #9370DB; }
        
        .menu-table { margin: 20px auto; background-color: #008080; border-collapse: collapse; border-radius: 10px; overflow: hidden; margin-left: auto; margin-right: auto; }
        .menu-table td { padding: 12px 20px; border: 1px solid #FFFFFF; }
        .menu-table a { text-decoration: none; color: #FFFFFF; font-weight: bold; }
        
        .form-container { background: white; border: 5px solid #9370DB; border-radius: 30px; width: 90%; max-width: 650px; margin: 20px auto; padding: 25px; box-shadow: 10px 10px 0px #9370DB; }
        label { display: block; margin-top: 15px; font-weight: bold; text-align: left; }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: 2px solid #9370DB; box-sizing: border-box; font-family: inherit; }
        
        .btn-envoi { background: #9370DB; color: white; border: none; padding: 18px 40px; border-radius: 25px; font-weight: bold; cursor: pointer; font-size: 1.2em; transition: 0.3s; }
        .btn-envoi:hover { transform: scale(1.05); }
        
        .carte-conflit { background: white; border-left: 10px solid #9370DB; border-radius: 15px; padding: 20px; margin: 20px auto; max-width: 650px; text-align: left; box-shadow: 4px 4px 10px rgba(0,0,0,0.1); }
        .reponse-sage { margin-left: 30px; margin-top: 10px; padding: 10px; background: #F3E5F5; border-left: 4px solid #9370DB; border-radius: 8px; font-size: 0.9em; }
        
        #searchBox { width: 90%; max-width: 650px; padding: 12px; margin: 20px auto; border-radius: 25px; border: 2px solid #9370DB; }
    </style>
</head>
<body>

    <div id="google_translate_element"></div>
    <script>function googleTranslateElementInit() { new google.translate.TranslateElement({pageLanguage: 'fr'}, 'google_translate_element'); }</script>
    <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <table class="menu-table">
        <tr>
            <td><a href="transition.html?page=index.html">Accueil</a></td>
            <td><a href="transition.html?page=formulaire.html">Semer</a></td>
            <td><a href="transition.html?page=jardin.html">Le Jardin</a></td>
            <td><a href="transition.html?page=regulation.html">R√©gulation</a></td>
        </tr>
    </table>

    <h1>‚öñÔ∏è R√©gulation Citoyenne</h1>

    <div class="form-container">
        <form id="regForm">
            <label>Ton Identit√© :</label>
            <input type="text" id="nom" placeholder="Ton nom ou pseudo" required>

            <label>Zone G√©ographique (Pays, Ville) :</label>
            <input type="text" id="ville" placeholder="Ex: France, Pessac" required>

            <label>Dur√©e de l'annonce :</label>
            <select id="duree">
                <option value="1 mois">1 mois</option>
                <option value="6 mois">6 mois</option>
                <option value="A vie">A vie</option>
            </select>

            <label>Expose ton conflit ou ton message :</label>
            <textarea id="message" rows="5" placeholder="D√©cris la situation avec sinc√©rit√©..." required></textarea>

            <button type="submit" id="btnEnvoi" class="btn-envoi">SOUMETTRE √Ä LA SAGESSE üïäÔ∏è</button>
        </form>
    </div>

    <input type="text" id="searchBox" onkeyup="filtrer()" placeholder="üîç Chercher une ville, un pays ou un nom...">
    
    <div id="flux-conflits">
        <p>Chargement des graines de sagesse...</p>
    </div>

    <script>
        // Ton URL de script Google Sheets
        const URL_SERVEUR = "https://script.google.com/macros/s/AKfycbz4ncs9qw_AfmKSER5QST-P0OeKQggQaq86QC6liS53uZ9sx4Lo_-4-h1knXKWqgQMc/exec";

        // Envoi du formulaire
        document.getElementById('regForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnEnvoi');
            btn.innerText = "Transmission..."; btn.disabled = true;

            fetch(URL_SERVEUR, { 
                method: 'POST', mode: 'no-cors', 
                body: JSON.stringify({
                    date: new Date().toLocaleDateString('fr-FR'),
                    type: "conflit",
                    nom: document.getElementById('nom').value,
                    localisation: document.getElementById('ville').value + " (" + document.getElementById('duree').value + ")",
                    message: document.getElementById('message').value
                })
            }).then(() => { 
                alert("Dossier d√©pos√© avec succ√®s !"); 
                location.reload(); 
            });
        });

        // Fonction pour ajouter un avis de sage
        function apporterAvis(dest) {
            const m = prompt("Quel est ton avis de sage ?");
            if (m) {
                const monNom = prompt("Ton nom de sage :") || "Anonyme";
                fetch(URL_SERVEUR, { 
                    method: 'POST', mode: 'no-cors', 
                    body: JSON.stringify({
                        date: new Date().toLocaleDateString('fr-FR'), 
                        type: "avis", 
                        nom: monNom, 
                        localisation: dest, 
                        message: m
                    })
                }).then(() => { 
                    alert("Avis ajout√© !"); 
                    location.reload(); 
                });
            }
        }

        // Chargement et affichage des donn√©es
        fetch(URL_SERVEUR)
            .then(r => r.json())
            .then(data => {
                const flux = document.getElementById('flux-conflits');
                flux.innerHTML = ""; // On vide le message de chargement
                
                const conflits = data.filter(d => d.type === "conflit").reverse();
                const avis = data.filter(d => d.type === "avis");
                
                conflits.forEach(c => {
                    let rHTML = ""; 
                    avis.filter(a => a.localisation === c.nom).forEach(a => {
                        rHTML += `<div class="reponse-sage"><b>üåø ${a.nom} :</b> ${a.message}</div>`;
                    });
                    
                    const div = document.createElement('div');
                    div.className = 'carte-conflit';
                    div.innerHTML = `
                        <small>${c.date}</small> - <b>${c.nom}</b> √† ${c.localisation}
                        <p><i>"${c.message}"</i></p>
                        ${rHTML}
                        <hr style="border:0; border-top: 1px dotted #9370DB;">
                        <span style="color:#9370DB; cursor:pointer; font-weight:bold; font-size:0.8em;" onclick="apporterAvis('${c.nom}')">‚öñÔ∏è APPORTER UN AVIS</span>
                    `;
                    flux.appendChild(div);
                });
            });

        // Fonction de recherche
        function filtrer() {
            let val = document.getElementById('searchBox').value.toLowerCase();
            let cards = document.getElementsByClassName('carte-conflit');
            for (let c of cards) { 
                c.style.display = c.innerText.toLowerCase().includes(val) ? "" : "none"; 
            }
        }
    </script>
</body>
</html>
