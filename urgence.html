<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Urgences & Imp√¥t Volontaire - Le Tr√©sor Public</title>
    <style>
        body { 
            font-family: 'Comic Sans MS', cursive, sans-serif; 
            background-color: #FFFF00; 
            color: #000080; 
            margin: 0; padding: 0; text-align: center; 
        }
        
        #google_translate_element { padding: 10px; background: rgba(255,255,255,0.5); border-bottom: 2px solid #008080; }
        
        /* MENU */
        .menu-table { margin: 20px auto; background-color: #008080; border-collapse: collapse; border-radius: 10px; overflow: hidden; }
        .menu-table td { padding: 12px 20px; border: 1px solid #FFFFFF; }
        .menu-table a { text-decoration: none; color: #FFFFFF; font-weight: bold; }
        
        /* FORMULAIRE */
        .form-container { 
            background: white; border: 5px solid #e91e63; border-radius: 30px; 
            width: 90%; max-width: 650px; margin: 30px auto; padding: 25px;
            box-shadow: 10px 10px 0px #e91e63;
        }
        
        h1 { color: #e91e63; margin-top: 20px; }
        label { display: block; margin-top: 15px; font-weight: bold; text-align: left; }
        
        input, textarea, select { 
            width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; 
            border: 2px solid #e91e63; box-sizing: border-box; font-family: inherit;
        }
        
        .btn-envoi { 
            background: #e91e63; color: white; border: none; padding: 18px 40px; 
            border-radius: 25px; font-weight: bold; cursor: pointer; font-size: 1.3em; margin-top: 20px;
            transition: 0.3s;
        }
        .btn-envoi:hover { transform: scale(1.05); background: #c2185b; }

        .info-historique { background: #fff3f3; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px dashed #e91e63; font-size: 0.9em; }

        /* LISTE DES ALERTES */
        .liste-alertes { max-width: 650px; margin: 40px auto; padding: 10px; text-align: left; }
        .carte-alerte { 
            background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;
            box-shadow: 4px 4px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <div id="google_translate_element"></div>
    <script type="text/javascript">
        function googleTranslateElementInit() { new google.translate.TranslateElement({pageLanguage: 'fr'}, 'google_translate_element'); }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <table class="menu-table">
        <tr>
            <td><a href="index.html">Accueil</a></td>
            <td><a href="formulaire.html">Semer</a></td>
            <td><a href="jardin.html">Le Jardin</a></td>
            <td><a href="regulation.html">R√©gulation</a></td>
            <td><a href="urgence.html">Urgences</a></td>
        </tr>
    </table>

    <h1>üì¢ Appels du C≈ìur & Urgences</h1>

    <div class="form-container">
        <div class="info-historique">
            <strong>Exemples de besoins du Tr√©sor Public :</strong><br>
            üõ†Ô∏è Toiture √† refaire ‚Ä¢ üå± Aide au jardinage ‚Ä¢ ü§ù Soutien mutuel
        </div>

        <form id="urgencyForm">
            <label>Nature du message :</label>
            <select id="type">
                <option value="Urgence">‚ù§Ô∏è URGENCE VITALE (Toiture, Sant√©, Faim...)</option>
                <option value="Imp√¥t">üìú IMP√îT VOLONTAIRE (Je donne de mon temps)</option>
            </select>

            <label>Ton Identit√© :</label>
            <input type="text" id="nom" placeholder="Ton nom ou pseudo" required>

            <label>Ta Localisation :</label>
            <input type="text" id="ville" placeholder="Ex: Pessac, France" required>

            <label>Ton Message :</label>
            <textarea id="message" rows="4" placeholder="D√©cris ton besoin ou ton offre de service..." required></textarea>

            <button type="submit" id="btnEnvoi" class="btn-envoi">LANCER L'APPEL üöÄ</button>
        </form>
    </div>

    <hr style="width: 80%; border: 1px solid #e91e63; opacity: 0.3;">

    <div class="liste-alertes">
        <h2 style="color: #e91e63; text-align: center;">üÜò Signaux du Jardin</h2>
        <div id="chargement" style="text-align:center;">√âcoute des signaux en cours...</div>
        <div id="flux-urgences"></div>
    </div>

    <script>
        const URL_SERVEUR = "https://script.google.com/macros/s/AKfycbz4ncs9qw_AfmKSER5QST-P0OeKQggQaq86QC6liS53uZ9sx4Lo_-4-h1knXKWqgQMc/exec";

        // 1. ENVOYER UN APPEL
        document.getElementById('urgencyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = document.getElementById('btnEnvoi');
            btn.innerText = "Transmission...";
            btn.disabled = true;

            const donnees = {
                date: new Date().toLocaleDateString('fr-FR'),
                type: document.getElementById('type').value,
                nom: document.getElementById('nom').value,
                localisation: document.getElementById('ville').value,
                message: document.getElementById('message').value
            };

            fetch(URL_SERVEUR, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(donnees)
            }).then(() => {
                alert("Ton appel a √©t√© diffus√© dans le Jardin !");
                location.reload();
            }).catch(err => {
                alert("Erreur lors de l'envoi.");
                btn.disabled = false;
            });
        });

        // 2. LIRE LES APPELS (URGENCES ET IMPOTS)
        fetch(URL_SERVEUR)
            .then(res => res.json())
            .then(data => {
                const flux = document.getElementById('flux-urgences');
                const chargement = document.getElementById('chargement');
                chargement.style.display = 'none';

                // Filtrer pour afficher Urgence et Imp√¥t
                const alertes = data.filter(d => d.type === "Urgence" || d.type === "Imp√¥t").reverse();

                if (alertes.length === 0) {
                    flux.innerHTML = "<p style='text-align:center;'>Aucun appel en cours. Le jardin est calme.</p>";
                } else {
                    alertes.forEach(u => {
                        const couleur = u.type === "Urgence" ? "#e91e63" : "#008080";
                        const icone = u.type === "Urgence" ? "üö®" : "üìú";
                        
                        const div = document.createElement('div');
                        div.className = 'carte-alerte';
                        div.style.borderLeft = `10px solid ${couleur}`;
                        div.innerHTML = `
                            <small>${u.date}</small> - <b style="color:${couleur}">${icone} ${u.type.toUpperCase()}</b><br>
                            <b>${u.nom}</b> √† ${u.localisation}<br>
                            <p style="margin-top:10px; font-style:italic; background:#f9f9f9; padding:10px; border-radius:5px;">
                                "${u.message}"
                            </p>
                            <button style="width:100%; padding:10px; cursor:pointer; background:white; border:2px solid ${couleur}; color:${couleur}; border-radius:10px; font-weight:bold;" onclick="alert('Contactez l‚Äôadministrateur pour r√©pondre √† cet appel !')">ü§ù J'APPORTE MON AIDE</button>
                        `;
                        flux.appendChild(div);
                    });
                }
            })
            .catch(err => {
                document.getElementById('chargement').innerText = "Le jardin est silencieux pour le moment.";
            });
    </script>

</body>
</html>
